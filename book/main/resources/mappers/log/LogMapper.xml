<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tccins.template.log.mapper.LogMapper">

	
	<!-- 로그 저장 -->
	<insert id="insertLog" parameterType="com.tccins.template.common.CamelMap">
		<selectKey resultType="String" order="BEFORE" keyProperty="logId">
			SELECT LPAD(IFNULL(MAX(LOG_ID),0)+1,6,'0') AS logId FROM LOG
		</selectKey>
		INSERT INTO LOG
		(
			LOG_ID
			,USER_ID
			,FRST_DTTM
			,IP_ADDR
			,MENU_URL
		)VALUES(
			#{logId}
			,#{userId}
			,DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
			,#{ipAddr}
			,#{menuUrl}
		)
	</insert>

	<!-- 접속 로그 리스트 조회 -->
	<select id="selectLoginLogList" parameterType="com.tccins.template.common.dto.SearchDto" resultType="com.tccins.template.common.CamelMap">
		SELECT 
			*
		FROM 
			(
			SELECT
				ROW_NUMBER() OVER(ORDER BY LOGIN_FRST_DTTM DESC) RNUM
				,A.*
			FROM 
				(
				SELECT 
					LOGIN_LOG_ID
					,LOGIN_USER_ID
					,(SELECT USER_NM FROM USER B WHERE A.LOGIN_USER_ID = B.USER_ID) USER_NM
					,LOGIN_GBN
					,LOGIN_LOG_CONTENTS
					,DATE_FORMAT(LOGIN_FRST_DTTM,'%Y-%m-%d %H:%i:%s') LOGIN_FRST_DTTM
					,LOGIN_IP_ADDR
				FROM LOGIN_LOG A
				) A
			WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(LOGIN_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(LOGIN_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND LOGIN_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(LOGIN_FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(LOGIN_FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
			) B
		ORDER BY B.LOGIN_FRST_DTTM DESC 
		LIMIT #{pagination.limitStart}, #{recordSize}
	</select>
	
	<!-- 접속 로그 카운트 조회 -->
	<select id="selectLoginLogCnt" parameterType="com.tccins.template.common.dto.SearchDto" resultType="int">
		SELECT 
			COUNT(*)
		FROM LOGIN_LOG
		WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(LOGIN_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								LOGIN_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(LOGIN_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND LOGIN_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(LOGIN_FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(LOGIN_FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
	</select>
	
	<!-- 에러 로그 리스트 조회 -->
	<select id="selectErrorLogList" parameterType="com.tccins.template.common.dto.SearchDto" resultType="com.tccins.template.common.CamelMap">
		SELECT 
			*
		FROM 
			(
			SELECT
				ROW_NUMBER() OVER(ORDER BY ERROR_FRST_DTTM DESC) RNUM
				,A.*
			FROM 
				(
				SELECT 
					ERROR_LOG_ID
					,ERROR_MENU_URL
					,ERROR_LOG_CONTENTS
					,ERROR_USER_ID
					,(SELECT USER_NM FROM USER B WHERE A.ERROR_USER_ID = B.USER_ID) USER_NM
					,DATE_FORMAT(ERROR_FRST_DTTM,'%Y-%m-%d %H:%i:%s') ERROR_FRST_DTTM
					,ERROR_IP_ADDR
				FROM ERROR_LOG A
				) A
			WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(ERROR_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								ERROR_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(ERROR_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND ERROR_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(ERROR_FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(ERROR_FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
			) B
		ORDER BY B.ERROR_FRST_DTTM DESC 
		LIMIT #{pagination.limitStart}, #{recordSize}
	</select>
	
	<!-- 에러 로그 카운트 조회 -->
	<select id="selectErrorLogCnt" parameterType="com.tccins.template.common.dto.SearchDto" resultType="int">
		SELECT 
			COUNT(*)
		FROM ERROR_LOG A
		WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(ERROR_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								ERROR_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(ERROR_USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND ERROR_IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(ERROR_FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(ERROR_FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
	</select>

	<!-- 로그 리스트 조회 -->
	<select id="selectLogList" parameterType="com.tccins.template.common.dto.SearchDto" resultType="com.tccins.template.common.CamelMap">
		SELECT 
			*
		FROM 
			(
			SELECT
				ROW_NUMBER() OVER(ORDER BY FRST_DTTM DESC) RNUM
				,A.*
			FROM 
				(
				SELECT 
					LOG_ID
					,MENU_URL
					,(SELECT USER_NM FROM USER B WHERE A.USER_ID = B.USER_ID) USER_NM
					,USER_ID
					,DATE_FORMAT(FRST_DTTM,'%Y-%m-%d %H:%i:%s') FRST_DTTM
					,IP_ADDR
				FROM LOG A
				) A
			WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
			) B
		ORDER BY B.FRST_DTTM DESC 
		LIMIT #{pagination.limitStart}, #{recordSize}
	</select>
	
	<!-- 로그 카운트 조회 -->
	<select id="logCount" parameterType="com.tccins.template.common.dto.SearchDto" resultType="int">
		SELECT 
			COUNT(*)
		FROM LOG A
		WHERE 1=1
			<if test="keyword != null and keyword != ''">
				<choose>
					<when test="searchType = '0'">
						AND
							(
								UPPER(USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
							OR
								IP_ADDR LIKE CONCAT('%',#{keyword},'%')
							)
					</when>
					<when test="searchType = '1'">
						AND UPPER(USER_ID) LIKE CONCAT('%',UPPER(#{keyword}),'%')
					</when>
					<when test="searchType = '2'">
						AND IP_ADDR LIKE CONCAT('%',#{keyword},'%')
					</when>
				</choose>
			</if>
			<if test="srchBgnDtm != null and srchBgnDtm != ''">
				<if test="srchEndDtm != null and srchEndDtm != ''">	
				<![CDATA[
					AND DATE_FORMAT(FRST_DTTM,'%Y%m%d') >= DATE_FORMAT(#{srchBgnDtm},'%Y%m%d')
					AND DATE_FORMAT(FRST_DTTM,'%Y%m%d') <= DATE_FORMAT(#{srchEndDtm},'%Y%m%d')
				]]>
				</if>		
			</if>
	</select>
	
	<!-- 로그 상세 조회 -->
	<select id="selectLogDetail" parameterType="java.util.Map" resultType="com.tccins.template.common.CamelMap">
		<choose>
			<when test="type.equals('log')">
				SELECT 
					LOG_ID
					,MENU_URL
					,USER_ID
					,DATE_FORMAT(FRST_DTTM,'%Y-%m-%d %H:%i:%s') FRST_DTTM
					,IP_ADDR
					,(SELECT USER_NM FROM USER WHERE USER_ID = A.USER_ID) USER_NM
					,'' LOG_CONTENTS
					,'' LOG_GBN
				FROM LOG A
				WHERE LOG_ID = #{logId}
			</when>
			<when test="type.equals('loginlog')">
				SELECT 
					LOGIN_LOG_ID AS LOG_ID
					,CASE 
						WHEN LOGIN_GBN = 'S' THEN '로그인성공'
						ELSE '로그인실패'
					END AS MENU_URL
					,LOGIN_USER_ID AS USER_ID
					,DATE_FORMAT(LOGIN_FRST_DTTM,'%Y-%m-%d %H:%i:%s') AS FRST_DTTM
					,LOGIN_IP_ADDR AS IP_ADDR
					,(SELECT USER_NM FROM USER WHERE USER_ID = A.LOGIN_USER_ID) AS USER_NM
					,LOGIN_LOG_CONTENTS AS LOG_CONTENTS
					,LOGIN_GBN AS LOG_GBN
				FROM LOGIN_LOG A
				WHERE LOGIN_LOG_ID = #{logId}
			</when>
			<when test="type.equals('errorlog')">
				SELECT 
					ERROR_LOG_ID AS LOG_ID
					,ERROR_MENU_URL AS MENU_URL
					,ERROR_USER_ID AS USER_ID
					,DATE_FORMAT(ERROR_FRST_DTTM,'%Y-%m-%d %H:%i:%s') AS FRST_DTTM
					,ERROR_IP_ADDR AS  IP_ADDR
					,(SELECT USER_NM FROM USER WHERE USER_ID = A.ERROR_USER_ID) AS USER_NM
					,ERROR_LOG_CONTENTS AS LOG_CONTENTS
					,'' AS LOG_GBN
				FROM ERROR_LOG A
				WHERE ERROR_LOG_ID = #{logId}
			</when>
		</choose>
	</select>
	
	
	<!-- 에러 로그 저장 -->
	<insert id="errorLogInsert" parameterType="com.tccins.template.common.CamelMap">
		<selectKey resultType="String" order="BEFORE" keyProperty="errorLogId">
			SELECT LPAD(IFNULL(MAX(ERROR_LOG_ID),0)+1,6,'0') AS logId FROM ERROR_LOG
		</selectKey>
		INSERT INTO ERROR_LOG(
			ERROR_LOG_ID
			,ERROR_MENU_URL
			,ERROR_LOG_CONTENTS
			,ERROR_USER_ID
			,ERROR_FRST_DTTM
			,ERROR_IP_ADDR
		)VALUES(
			#{errorLogId}
			,#{errorMenuUrl}
			,#{errorLogContents}
			,#{errorUserId}
			,DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
			,#{errorIpAddr}
		)
	</insert>

</mapper>